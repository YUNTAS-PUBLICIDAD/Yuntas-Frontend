import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{r as c}from"./index.ai7qpRr1.js";import{c as ae,d as te}from"./index.C2rrZm7j.js";import{g as E,c as D}from"./config.CT_CG-Xn.js";import{S as R}from"./sweetalert2.esm.all.B0Dix5B2.js";import{T as re}from"./TableContainer.BXE2yXaj.js";import"./iconBase.CsihB_xR.js";const se=({isOpen:f,setIsOpen:$,blogToEdit:l,onSuccess:M})=>{const[k,j]=c.useState([]),[L,B]=c.useState(""),[y,S]=c.useState(!1),[z,C]=c.useState(!1),[g,_]=c.useState(null),[h,w]=c.useState(null),[I,v]=c.useState(""),[O,s]=c.useState(!1),[d,p]=c.useState(""),i={producto_id:"",subtitulo:"",link:"",meta_titulo:"",meta_descripcion:"",imagen_principal:null,text_alt_principal:"",alt_imagen_card:"",imagenes_secundarias:[null,null,null],alt_imagenes_secundarias:["","",""],parrafos:["","",""],url_video:""},[a,x]=c.useState(i);c.useEffect(()=>{if(f)if(l){const r=l.producto_id?.toString()||"";x({producto_id:r,subtitulo:l.subtitulo||"",link:l.link||"",meta_titulo:l.etiqueta?.meta_titulo||"",meta_descripcion:l.etiqueta?.meta_descripcion||"",imagen_principal:null,text_alt_principal:l.text_alt_principal||"",alt_imagen_card:l.alt_imagen_card||"",imagenes_secundarias:[null,null,null],alt_imagenes_secundarias:[l.imagenes?.[0]?.text_alt||"",l.imagenes?.[1]?.text_alt||"",l.imagenes?.[2]?.text_alt||""],parrafos:[l.parrafos?.[0]?.parrafo||"",l.parrafos?.[1]?.parrafo||"",l.parrafos?.[2]?.parrafo||""],url_video:l.url_video||""}),B(l.nombre_producto||"")}else x(i),B("")},[f,l]),c.useEffect(()=>{(async()=>{if(f){S(!0);try{const t=localStorage.getItem("token"),n=await fetch(E(D.endpoints.productos.list),{method:"GET",headers:{Authorization:`Bearer ${t}`,Accept:"application/json","Content-Type":"application/json"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=await n.json();o.success&&Array.isArray(o.data)?j(o.data):Array.isArray(o)?j(o):j([])}catch(t){console.error("Error al obtener productos:",t),j([]),alert("❌ Error al cargar los productos. Por favor, intenta de nuevo.")}finally{S(!1)}}})()},[f]);const A=r=>{x({...a,[r.target.name]:r.target.value})},F=r=>{x({...a,[r.target.name]:r.target.value})},H=(r,t)=>{r.target.files?.[0]&&x({...a,[t]:r.target.files[0]})},G=(r,t)=>{const n=[...a.imagenes_secundarias];n[t]=r.target.files?.[0]||null,x({...a,imagenes_secundarias:n})},J=(r,t)=>{const n=[...a.alt_imagenes_secundarias];n[t]=r.target.value,x({...a,alt_imagenes_secundarias:n})},V=(r,t)=>{const n=[...a.parrafos];n[t]=r.target.value,x({...a,parrafos:n})},W=r=>{const t=document.getElementById(`parrafo-${r}`);if(!t)return;const n=t.selectionStart,o=t.selectionEnd;if(n===o){R.fire("Selecciona texto","Selecciona una palabra o frase antes de insertar el enlace.","warning");return}const m=t.value.substring(n,o);_(r),w({start:n,end:o}),v(m),C(!0)},K=()=>{if(g===null||h===null||!d.trim())return;const r=a.parrafos[g],t=`<a href="${d}" target="_blank" rel="noopener noreferrer">${I}</a>`,n=r.slice(0,h.start)+t+r.slice(h.end),o=[...a.parrafos];o[g]=n,x({...a,parrafos:o}),_(null),w(null),v(""),p(""),C(!1)},Q=r=>{const t=document.getElementById(`parrafo-${r}`);if(!t)return;const n=t.selectionStart,o=t.selectionEnd,m=t.value.substring(n,o);if(!m){R.fire("Selecciona texto","Selecciona una palabra o frase para enlazar a un producto.","warning");return}_(r),w({start:n,end:o}),v(m),s(!0)},X=r=>{if(g===null||h===null)return;const t=a.parrafos[g],o=`<a href="/products/producto/?link=${r.link}" style="color: blue; text-decoration: underline;">${I}</a>`,m=t.slice(0,h.start)+o+t.slice(h.end),u=[...a.parrafos];u[g]=m,x({...a,parrafos:u}),_(null),w(null),v(""),s(!1)},q=()=>{$(!1),_(null),w(null),v(""),C(!1),s(!1),p(""),x(i)},Y=async r=>{r.preventDefault();const t=!!l;if(!a.producto_id)return alert("⚠️ Debe seleccionar un producto.");if(!a.subtitulo.trim())return alert("⚠️ El subtítulo es obligatorio.");if(!t&&!a.imagen_principal)return alert("⚠️ La imagen principal es obligatoria para crear.");const n=a.parrafos.filter(m=>m.trim());if(n.length===0)return alert("⚠️ Debe haber al menos un párrafo con contenido.");const o=/^[a-z0-9]+(?:-[a-z0-9]+)*$/;if(a.link&&!o.test(a.link))return alert("⚠️ El link debe ser URL-friendly (solo minúsculas, guiones y números).");try{S(!0);const m=localStorage.getItem("token"),u=new FormData;u.append("producto_id",a.producto_id),u.append("subtitulo",a.subtitulo),u.append("url_video",a.url_video),a.link?.trim()&&u.append("link",a.link.trim());const U={meta_titulo:a.meta_titulo?.trim()||"",meta_descripcion:a.meta_descripcion?.trim()||""};(U.meta_titulo||U.meta_descripcion)&&u.append("etiqueta",JSON.stringify(U)),a.text_alt_principal?.trim()&&u.append("text_alt_principal",a.text_alt_principal.trim()),a.alt_imagen_card?.trim()&&u.append("alt_imagen_card",a.alt_imagen_card.trim()),a.imagen_principal&&u.append("imagen_principal",a.imagen_principal),a.imagenes_secundarias.filter(b=>b!==null).forEach(b=>u.append("imagenes[]",b)),a.alt_imagenes_secundarias.forEach((b,P)=>{(a.imagenes_secundarias[P]!==null||t&&b.trim())&&u.append("alt_imagenes[]",b.trim())}),n.forEach(b=>u.append("parrafos[]",b.trim()));const Z=t?E(D.endpoints.blogs.update(l.id)):E(D.endpoints.blogs.create);t&&u.append("_method","PUT");const T=await fetch(Z,{method:"POST",body:u,headers:{Authorization:`Bearer ${m}`,Accept:"application/json"}});let N;try{N=await T.json()}catch{N=await T.text()}if(T.ok)alert(`✅ Blog ${t?"actualizado":"creado"} correctamente.`),q(),M?.();else if(N.errors){let b=`❌ Errores de validación:
`;Object.keys(N.errors).forEach(P=>{const ee=Array.isArray(N.errors[P])?N.errors[P]:[N.errors[P]];b+=`• ${P}: ${ee.join(", ")}
`}),alert(b)}else alert(`❌ Error (${T.status}): ${N.message||JSON.stringify(N)}`)}catch(m){console.error("❌ Error en la solicitud:",m),alert("❌ Error en la conexión con el servidor.")}finally{S(!1)}};return f?e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 z-50",children:e.jsxs("div",{className:"bg-white text-black px-4 sm:px-6 md:px-8 py-6 rounded-lg max-h-[90vh] w-full max-w-5xl mx-2 overflow-y-auto",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6 text-center md:text-left",children:l?"Editar Blog":"Añadir Blog"}),e.jsxs("form",{onSubmit:Y,encType:"multipart/form-data",className:"space-y-8",children:[e.jsxs("div",{className:"bg-blue-50 p-4 sm:p-6 rounded-lg border border-blue-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-4",children:"Información Principal & SEO"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"col-span-1 md:col-span-4",children:[e.jsxs("label",{className:"block mb-2 font-medium",children:["Producto ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{name:"producto_id",value:a.producto_id,onChange:F,required:!0,className:"w-full bg-white text-black p-2 rounded-md border border-gray-300",disabled:y,children:[e.jsx("option",{value:"",children:y?"Cargando productos...":"-- Selecciona un producto --"}),k.map(r=>e.jsx("option",{value:r.id.toString(),children:r.nombre||`Producto ${r.id}`},r.id))]}),L&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Producto seleccionado: ",e.jsx("strong",{children:L})]})]}),e.jsxs("div",{className:"col-span-1 md:col-span-2",children:[e.jsxs("label",{className:"block font-medium mb-1",children:["Subtítulo ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{name:"subtitulo",value:a.subtitulo,onChange:A,className:"w-full border border-gray-300 rounded px-3 py-2",required:!0})]}),e.jsxs("div",{className:"col-span-1 md:col-span-2",children:[e.jsx("label",{className:"block font-medium mb-1",children:"Meta título"}),e.jsx("input",{type:"text",name:"meta_titulo",value:a.meta_titulo||"",onChange:A,placeholder:"Título optimizado para SEO",className:"w-full border border-gray-300 rounded px-3 py-2"})]}),e.jsxs("div",{className:"col-span-1 md:col-span-2",children:[e.jsx("label",{className:"block font-medium mb-1",children:"Meta descripción"}),e.jsx("input",{type:"text",name:"meta_descripcion",value:a.meta_descripcion||"",onChange:A,placeholder:"Descripción optimizada para SEO",className:"w-full border border-gray-300 rounded px-3 py-2"})]}),e.jsxs("div",{className:"col-span-1 md:col-span-4",children:[e.jsx("label",{className:"block font-medium mb-1",children:"Link (URL amigable)"}),e.jsx("input",{type:"text",name:"link",value:a.link,onChange:A,placeholder:"ejemplo: mi-blog-post",className:"w-full border border-gray-300 rounded px-3 py-2"})]})]})]}),e.jsxs("div",{className:"bg-green-50 p-4 sm:p-6 rounded-lg border border-green-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-green-800 mb-4",children:"Imágenes"}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"border border-green-400 rounded p-4",children:[e.jsxs("label",{className:"block font-medium mb-2",children:["Imagen Principal ",!l&&e.jsx("span",{className:"text-red-500",children:"*"})]}),l?.imagen_principal&&e.jsx("img",{src:l.imagen_principal,alt:a.text_alt_principal||"Imagen principal",className:"w-full h-48 sm:h-64 object-cover rounded mb-4 border"}),e.jsx("input",{type:"file",accept:"image/*",onChange:r=>H(r,"imagen_principal"),className:"w-full file:py-2 file:px-3 file:border-0 file:bg-green-100 file:text-green-700 hover:file:bg-green-200"}),e.jsx("input",{type:"text",name:"text_alt_principal",placeholder:"Texto ALT para SEO",value:a.text_alt_principal,onChange:A,className:"mt-2 w-full border border-gray-300 rounded px-3 py-2"})]}),e.jsxs("div",{className:"border border-green-400 rounded p-4",children:[e.jsx("label",{className:"block font-semibold mb-4",children:"Imágenes Secundarias"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6",children:a.imagenes_secundarias.map((r,t)=>e.jsxs("div",{className:"flex flex-col items-center",children:[l?.imagenes?.[t]?.ruta_imagen&&e.jsx("img",{src:l.imagenes[t].ruta_imagen,alt:a.alt_imagenes_secundarias[t]||`Imagen secundaria #${t+1}`,className:"w-full h-32 object-cover rounded mb-2 border"}),e.jsx("input",{type:"file",accept:"image/*",onChange:n=>G(n,t),className:"w-full file:py-2 file:px-3 file:border-0 file:bg-green-100 file:text-green-700 hover:file:bg-green-200"}),e.jsx("input",{type:"text",placeholder:`Texto ALT imagen secundaria #${t+1}`,value:a.alt_imagenes_secundarias[t],onChange:n=>J(n,t),className:"w-full border border-gray-300 rounded px-3 py-2 mt-2"})]},t))})]})]})]}),e.jsxs("div",{className:"bg-purple-50 p-4 sm:p-6 rounded-lg border border-purple-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-purple-800 mb-4",children:"Video"}),e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"URL del Video *"}),e.jsx("input",{type:"url",name:"url_video",value:a.url_video,onChange:A,required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"bg-yellow-50 p-4 sm:p-6 rounded-lg border border-yellow-200",children:[e.jsxs("h3",{className:"text-lg font-semibold text-yellow-800 mb-4",children:["Párrafos ",e.jsx("span",{className:"text-red-500",children:"*"})]}),a.parrafos.map((r,t)=>e.jsxs("div",{className:"relative mb-6",children:[e.jsx("textarea",{id:`parrafo-${t}`,value:r,onChange:n=>V(n,t),className:"w-full border border-gray-300 rounded px-3 py-2 pr-20",rows:4,placeholder:`Párrafo ${t+1} (opcional)`}),e.jsxs("div",{className:"absolute top-2 right-2 flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>W(t),className:"bg-blue-500 hover:bg-blue-700 text-white p-2 rounded-full shadow-lg transition",children:"🔗"}),e.jsx("button",{type:"button",onClick:()=>Q(t),className:"bg-green-500 hover:bg-green-700 text-white p-2 rounded-full shadow-lg transition",children:"🛒"})]})]},t))]}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-3 sm:gap-4",children:[e.jsx("button",{type:"button",onClick:q,className:"bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded",disabled:y,children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:y,className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded disabled:opacity-50",children:y?"Procesando...":l?"Actualizar":"Crear"})]})]}),z&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 z-[60]",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg max-w-md w-full mx-4",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Insertar Enlace"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["Texto seleccionado: ",e.jsxs("strong",{children:['"',I,'"']})]}),e.jsx("input",{type:"url",value:d,onChange:r=>p(r.target.value),placeholder:"https://ejemplo.com",className:"w-full border border-gray-300 rounded px-3 py-2 mb-4",required:!0}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>C(!1),className:"bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded",children:"Cancelar"}),e.jsx("button",{type:"button",onClick:K,disabled:!d.trim(),className:"bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 text-white px-4 py-2 rounded",children:"Insertar"})]})]})}),O&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 z-[60]",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg max-w-md w-full mx-4",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Enlazar a Producto"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Texto seleccionado: ",e.jsxs("strong",{children:['"',I,'"']})]}),e.jsxs("select",{onChange:r=>{const t=parseInt(r.target.value),n=k.find(o=>o.id===t);n&&X(n)},className:"w-full border border-gray-300 rounded px-3 py-2 mb-4",children:[e.jsx("option",{value:"",children:"-- Seleccionar producto --"}),k.map(r=>e.jsx("option",{value:r.id,children:r.nombre},r.id))]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"button",onClick:()=>s(!1),className:"bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded",children:"Cancelar"})})]})})]})}):null},me=()=>{const[f,$]=c.useState([]),[l,M]=c.useState(1),k=5,[j,L]=c.useState({current_page:1,last_page:1,per_page:k,total:0}),[B,y]=c.useState(null),[S,z]=c.useState(!0),[C,g]=c.useState(!1),_=async(s=1)=>{z(!0);try{const d=localStorage.getItem("token"),p=await fetch(`${E(D.endpoints.blogs.list)}?page=${s}&per_page=${k}`,{headers:{Authorization:`Bearer ${d}`,Accept:"application/json"}});if(!p.ok)throw new Error(`HTTP error! status: ${p.status}`);const i=await p.json();console.log("API Result:",i),i.success&&i.data&&Array.isArray(i.data.data)?($(i.data.data),L({current_page:i.data.current_page??s,last_page:i.data.last_page,per_page:i.data.per_page,total:i.data.total})):(console.warn("⚠️ Estructura inesperada:",i.data),$([]))}catch(d){console.error("❌ Error al cargar datos:",d),$([])}finally{z(!1)}};c.useEffect(()=>{_(l)},[l]);const h=s=>{s>=1&&s<=j.last_page&&M(s)},w=async s=>{const d=localStorage.getItem("token");if(window.confirm("¿Estás seguro de que deseas eliminar este blog?"))try{const i=await fetch(E(D.endpoints.blogs.delete(s)),{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`}});if(i.ok)_(l),alert("✅ Blog eliminado exitosamente");else{const a=await i.json().catch(()=>({}));alert(`❌ Error al eliminar el blog: ${a.message||"Error desconocido"}`)}}catch{alert("❌ Error al conectar con el servidor")}},I=s=>s?s.startsWith("http")?s:`https://apiyuntas.yuntaspublicidad.com${s}`:"/placeholder-image.jpg",v=(s,d=50)=>s?s.length>d?s.substring(0,d)+"...":s:"",O=()=>{y(null),g(!0)};return e.jsxs("div",{className:"overflow-x-auto p-2 sm:p-4",children:[e.jsxs(re,{tableType:"blogs",exportData:f,onAddNew:O,children:[e.jsx("thead",{className:"hidden md:table-header-group",children:e.jsx("tr",{className:"bg-blue-950 text-white",children:["ID","PRODUCTO","SUBTÍTULO","IMAGEN","FECHA","ACCIÓN"].map(s=>e.jsx("th",{className:"px-4 py-2 bg-cyan-400 text-white uppercase text-xs font-bold rounded-md",children:s},s))})}),e.jsx("tbody",{children:S?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-center py-4 text-gray-500 block md:table-cell",children:"Cargando blogs..."})}):f.length>0?f.map((s,d)=>e.jsxs("tr",{className:`md:table-row block md:mb-0 mb-6 rounded-xl shadow-md overflow-hidden border ${d%2===0?"bg-white":"bg-gray-50"}`,children:[e.jsx("td",{"data-label":"ID",className:"px-4 py-2 border-b font-bold",children:s.id}),e.jsx("td",{"data-label":"Producto",className:"px-4 py-2 border-b font-semibold",children:v(s.nombre_producto||"Sin nombre",30)}),e.jsx("td",{"data-label":"Subtítulo",className:"px-4 py-2 border-b",children:v(s.subtitulo,40)}),e.jsx("td",{"data-label":"Fecha",className:"px-4 py-2 border-b text-sm",children:s.created_at?new Date(s.created_at).toLocaleDateString("es-ES"):"N/A"}),e.jsxs("td",{"data-label":"Imagen",className:"px-4 py-2 border-b border-gray-200 block md:table-cell relative md:static flex flex-col items-center",children:[e.jsx("span",{className:"block text-gray-600 font-semibold mb-2 md:hidden",children:"Imagen"}),e.jsx("img",{src:I(s.imagen_principal),alt:s.nombre_producto||"Blog",className:"w-full max-w-[280px] h-40 sm:w-20 sm:h-20 rounded-lg object-cover shadow-md",onError:p=>{const i=p.target;i.src="/placeholder-image.jpg"}})]}),e.jsx("td",{"data-label":"Acción",className:"px-4 py-3",children:e.jsxs("div",{className:"flex flex-col sm:flex-row justify-center gap-3 mt-2 sm:mt-0",children:[e.jsxs("button",{className:"flex items-center justify-center gap-2 p-2 text-red-600 hover:text-red-800 transition bg-red-100 rounded-lg shadow-sm",title:"Eliminar",onClick:()=>w(s.id),children:[e.jsx(ae,{size:18}),e.jsx("span",{className:"md:hidden font-medium",children:"Borrar"})]}),e.jsxs("button",{className:"flex items-center justify-center gap-2 p-2 text-yellow-600 hover:text-yellow-800 transition bg-yellow-100 rounded-lg shadow-sm",title:"Editar",onClick:()=>{y(s),g(!0)},children:[e.jsx(te,{size:18}),e.jsx("span",{className:"md:hidden font-medium",children:"Editar"})]})]})})]},s.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-center py-4 text-gray-500",children:"No hay blogs disponibles"})})})]}),j.last_page>1&&e.jsxs("div",{className:"flex flex-wrap justify-center items-center mt-4 gap-2",children:[e.jsx("button",{onClick:()=>h(l-1),disabled:l===1,className:"px-4 py-2 bg-blue-950 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-800 transition-colors",children:"Anterior"}),Array.from({length:j.last_page},(s,d)=>{const p=d+1;return e.jsx("button",{onClick:()=>h(p),className:`px-3 py-2 rounded-md ${l===p?"bg-blue-950 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:p},p)}),e.jsx("button",{onClick:()=>h(l+1),disabled:l===j.last_page,className:"px-4 py-2 bg-blue-950 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-800 transition-colors",children:"Siguiente"})]}),e.jsx("button",{onClick:O,className:"mt-4 mb-6 bg-blue-950 hover:bg-blue-800 text-white text-lg px-8 sm:px-10 py-2 rounded-full w-full sm:w-auto",children:"Añadir Blog"}),e.jsx(se,{isOpen:C,setIsOpen:g,blogToEdit:B,onSuccess:()=>{y(null),g(!1),_(l)}})]})};export{me as default};
